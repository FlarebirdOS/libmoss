# moss-config

Relevant source files

* [meson\_options.txt](../meson_options.txt)
* [source/moss/config/io/configuration.d](../source/moss/config/io/configuration.d)
* [source/moss/config/io/package.d](../source/moss/config/io/package.d)
* [source/moss/config/io/schema.d](../source/moss/config/io/schema.d)

## Purpose and Scope

The `moss-config` component provides a sophisticated configuration management system for Serpent OS applications. It implements a layered configuration model where vendor-provided defaults can be overridden by administrator settings, supports YAML-based configuration files organized as snippets, and includes configuration masking capabilities. This component is optional and can be enabled via the `--with-config` build option (see [Component Selection](2.2-component-selection)).

For comprehensive details about the configuration system architecture, layering mechanics, schema validation, and snippet management, see [Configuration Management Deep Dive](4-configuration-management-deep-dive).

## Component Architecture

The `moss-config` component consists of three primary modules that work together to provide flexible configuration management:

```mermaid
flowchart TD

CONFIG["Configuration<C><br>source/moss/config/io/configuration.d"]
SNIPPET["Snippet<C><br>source/moss/config/io/snippet.d"]
SCHEMA["YamlSchema & ConfigurationDomain<br>source/moss/config/io/schema.d"]
PACKAGE["moss.config.io<br>source/moss/config/io/package.d"]
USER["Application Code"]

PACKAGE --> CONFIG
PACKAGE --> SNIPPET
PACKAGE --> SCHEMA
CONFIG --> SNIPPET
CONFIG --> SCHEMA
SNIPPET --> SCHEMA
USER --> PACKAGE
USER --> CONFIG
```

**Sources:** [source/moss/config/io/package.d1-20](../source/moss/config/io/package.d#L1-L20) [source/moss/config/io/configuration.d1-385](../source/moss/config/io/configuration.d#L1-L385) [source/moss/config/io/schema.d1-54](../source/moss/config/io/schema.d#L1-L54)

## Template-Based Configuration

The `Configuration<C>` class is a template that operates on user-defined configuration structures. The template parameter `C` determines the configuration style:

| Configuration Style | Template Type | Behavior |
| --- | --- | --- |
| **Array Configuration** | `Configuration<T[]>` | Multiple sections with unique IDs; sections can override each other |
| **Flat Configuration** | `Configuration<T>` | Single configuration object; fields can be overridden |

The configuration style is automatically detected at compile-time via `isArray!ConfType` [source/moss/config/io/configuration.d266](../source/moss/config/io/configuration.d#L266-L266)

**Sources:** [source/moss/config/io/configuration.d87-88](../source/moss/config/io/configuration.d#L87-L88) [source/moss/config/io/configuration.d264-266](../source/moss/config/io/configuration.d#L264-L266)

## Configuration Paths and Search Order

### Path Structure

The `Configuration<C>` class constructs search paths based on a `ConfigurationDomain` UDA that must be attached to the configuration structure:

```mermaid
flowchart TD

DOMAIN["@ConfigurationDomain<br>applicationIdentity + domain"]
VENDOR_FILE["Vendor File Path<br>{prefix}/share/{appId}/{domain}.conf"]
VENDOR_DIR["Vendor Directory Path<br>{prefix}/share/{appId}/{domain}.conf.d"]
ADMIN_FILE["Admin File Path<br>/etc/{appId}/{domain}.conf"]
ADMIN_DIR["Admin Directory Path<br>/etc/{appId}/{domain}.conf.d"]

DOMAIN --> VENDOR_FILE
DOMAIN --> VENDOR_DIR
DOMAIN --> ADMIN_FILE
DOMAIN --> ADMIN_DIR
```

**Sources:** [source/moss/config/io/configuration.d92-119](../source/moss/config/io/configuration.d#L92-L119) [source/moss/config/io/schema.d31-35](../source/moss/config/io/schema.d#L31-L35)

### Directory Constants

The system uses two base directory constants defined in the `Directories` enum:

* `Directories.Vendor = "share"` - Vendor configuration base path [source/moss/config/io/configuration.d77](../source/moss/config/io/configuration.d#L77-L77)
* `Directories.Admin = "etc"` - Administrator configuration base path [source/moss/config/io/configuration.d78](../source/moss/config/io/configuration.d#L78-L78)

The vendor prefix defaults to `"usr"` but can be customized via the `Configuration<C>` constructor [source/moss/config/io/configuration.d92](../source/moss/config/io/configuration.d#L92-L92)

**Sources:** [source/moss/config/io/configuration.d75-79](../source/moss/config/io/configuration.d#L75-L79)

## Configuration Loading Process

### Load Flow

The `load(string rootPrefix)` method orchestrates the configuration loading process:

```mermaid
flowchart TD

START["load(rootPrefix)"]
ITERATE["Iterate SearchPath[] _paths"]
CHECK_EXISTS["Path exists?"]
CHECK_TYPE["Path type?"]
DIR["Directory<br>(*.conf.d)"]
FILE["File<br>(*.conf)"]
SCAN_DIR["dirEntries(path)<br>Filter .conf files<br>Sort alphabetically"]
LOAD_SNIPPETS["loadConfigFile(path, type)<br>for each file"]
MASKING["Check if Admin<br>snippet is masked"]
DISABLE_VENDOR["Disable matching<br>vendor snippet"]
LOAD_SNIPPET["snippet.load()"]
APPEND["Append to _snippets"]
FINALIZE["Configuration type?"]
ARRAY["loadSections()<br>Merge array config"]
FLAT["loadConfiguration()<br>Merge flat config"]
DONE["Configuration ready"]

START --> ITERATE
ITERATE --> CHECK_EXISTS
CHECK_EXISTS --> ITERATE
CHECK_EXISTS --> CHECK_TYPE
CHECK_TYPE --> DIR
CHECK_TYPE --> FILE
DIR --> SCAN_DIR
SCAN_DIR --> LOAD_SNIPPETS
FILE --> LOAD_SNIPPETS
LOAD_SNIPPETS --> MASKING
MASKING --> DISABLE_VENDOR
MASKING --> LOAD_SNIPPET
DISABLE_VENDOR --> ITERATE
LOAD_SNIPPET --> APPEND
APPEND --> ITERATE
ITERATE --> FINALIZE
FINALIZE --> ARRAY
FINALIZE --> FLAT
ARRAY --> DONE
FLAT --> DONE
```

**Sources:** [source/moss/config/io/configuration.d140-186](../source/moss/config/io/configuration.d#L140-L186) [source/moss/config/io/configuration.d238-262](../source/moss/config/io/configuration.d#L238-L262)

### Configuration Masking

Configuration files can be "masked" by creating a symbolic link to `/dev/null` [source/moss/config/io/configuration.d31](../source/moss/config/io/configuration.d#L31-L31) When an admin snippet is masked, the system disables any matching vendor snippet with the same name:

```mermaid
flowchart TD

ADMIN_SNIPPET["Admin Snippet<br>/etc/app/domain.conf"]
SYMLINK["/dev/null"]
CHECK["isMasked(path)"]
VENDOR_SNIPPET["Vendor Snippet<br>/usr/share/app/domain.conf"]
DISABLED["Snippet disabled"]

ADMIN_SNIPPET --> SYMLINK
ADMIN_SNIPPET --> CHECK
CHECK --> VENDOR_SNIPPET
VENDOR_SNIPPET --> DISABLED
```

**Sources:** [source/moss/config/io/configuration.d246-253](../source/moss/config/io/configuration.d#L246-L253) [source/moss/config/io/configuration.d366-374](../source/moss/config/io/configuration.d#L366-L374)

## Configuration Merging Strategies

### Array Configuration (Sections)

For array-style configurations (`Configuration<T[]>`), the system maintains a dictionary of sections keyed by their ID:

```mermaid
flowchart TD

VENDOR_SNIP1["Vendor Snippet 1<br>Section A: field1=x"]
VENDOR_SNIP2["Vendor Snippet 2<br>Section B: field1=y"]
ADMIN_SNIP1["Admin Snippet 1<br>Section A: field2=z"]
SECTIONS["_sections: ElemType[string]"]
SEC_A["Section A<br>field1=x (from vendor)<br>field2=z (from admin)"]
SEC_B["Section B<br>field1=y (from vendor)"]
MERGE["loadSnippetSections()<br>Field-level override via<br>FieldNameTuple iteration"]

VENDOR_SNIP1 --> SECTIONS
VENDOR_SNIP2 --> SECTIONS
ADMIN_SNIP1 --> SECTIONS
SECTIONS --> SEC_A
SECTIONS --> SEC_B
MERGE --> SECTIONS
```

The `loadSnippetSections()` method iterates through `FieldNameTuple!ElemType` to perform field-level overrides [source/moss/config/io/configuration.d301-312](../source/moss/config/io/configuration.d#L301-L312)

**Sources:** [source/moss/config/io/configuration.d272-324](../source/moss/config/io/configuration.d#L272-L324)

### Flat Configuration (Single Object)

For flat configurations (`Configuration<T>`), all snippets contribute fields to a single `_config` object:

```mermaid
flowchart TD

VENDOR_SNIP1["Vendor Snippet 1<br>field1=a, field2=b"]
VENDOR_SNIP2["Vendor Snippet 2<br>field2=c, field3=d"]
ADMIN_SNIP1["Admin Snippet 1<br>field1=e"]
CONFIG["_config: ElemType"]
RESULT["Final Configuration<br>field1=e (admin override)<br>field2=c (vendor 2)<br>field3=d (vendor 2)"]
MERGE["loadSnippetConfiguration()<br>Field-level override via<br>FieldNameTuple iteration"]

VENDOR_SNIP1 --> CONFIG
VENDOR_SNIP2 --> CONFIG
ADMIN_SNIP1 --> CONFIG
CONFIG --> RESULT
MERGE --> CONFIG
```

The `loadSnippetConfiguration()` method uses `explicitlyDefined(name)` to determine which fields were explicitly set in each snippet [source/moss/config/io/configuration.d344](../source/moss/config/io/configuration.d#L344-L344)

**Sources:** [source/moss/config/io/configuration.d327-360](../source/moss/config/io/configuration.d#L327-L360)

## Schema Validation

### YamlSchema UDA

The `YamlSchema` struct is a User-Defined Attribute (UDA) that provides field-level validation metadata:

| Field | Type | Purpose |
| --- | --- | --- |
| `name` | `string` | YAML key name (may differ from struct field name) |
| `required` | `bool` | Whether this field must be present |
| `type` | `YamlType` | Expected YAML value type (Single, Array, or Map) |
| `acceptableValues` | `string[]` | Whitelist of valid string values |

**Sources:** [source/moss/config/io/schema.d40-53](../source/moss/config/io/schema.d#L40-L53)

### YamlType Enumeration

The `YamlType` enum defines the three supported YAML value types:

```mermaid
flowchart TD

YAMLTYPE["YamlType enum"]
SINGLE["Single = 0<br>Scalar value"]
ARRAY["Array = 1<br>Sequence/list"]
MAP["Map = 2<br>Mapping/dictionary"]

YAMLTYPE --> SINGLE
YAMLTYPE --> ARRAY
YAMLTYPE --> MAP
```

**Sources:** [source/moss/config/io/schema.d21-26](../source/moss/config/io/schema.d#L21-L26)

### ConfigurationDomain UDA

Every configuration structure must be annotated with `@ConfigurationDomain`:

```mermaid
flowchart TD

UDA["@ConfigurationDomain"]
APP_ID["applicationIdentity<br>e.g., 'moss'"]
DOMAIN["domain<br>e.g., 'repos'"]
PATH_VENDOR["Vendor Path<br>/usr/share/{applicationIdentity}/{domain}.conf"]
PATH_ADMIN["Admin Path<br>/etc/{applicationIdentity}/{domain}.conf"]

UDA --> APP_ID
UDA --> DOMAIN
APP_ID --> PATH_VENDOR
DOMAIN --> PATH_VENDOR
APP_ID --> PATH_ADMIN
DOMAIN --> PATH_ADMIN
```

The `Configuration<C>` constructor validates that exactly one `ConfigurationDomain` UDA is present and that both fields are non-empty [source/moss/config/io/configuration.d94-99](../source/moss/config/io/configuration.d#L94-L99)

**Sources:** [source/moss/config/io/schema.d31-35](../source/moss/config/io/schema.d#L31-L35) [source/moss/config/io/configuration.d94-100](../source/moss/config/io/configuration.d#L94-L100)

## Key Configuration Class Members

### Type Aliases and Properties

The `Configuration<C>` class defines several internal type aliases based on the template parameter:

```mermaid
flowchart TD

TEMPLATE["Configuration<C>"]
CONFTYPE["ConfType = C"]
SNIPPETTYPE["SnippetType = Snippet!ConfType"]
ARRAYCONFIG["arrayConfig = isArray!ConfType"]
BRANCH["arrayConfig?"]
ARRAY_ELEM["ElemType = typeof(*ConfType.init.ptr)<br>_sections: ElemType[string]"]
FLAT_ELEM["ElemType = ConfType<br>_config: ElemType"]

TEMPLATE --> CONFTYPE
TEMPLATE --> SNIPPETTYPE
TEMPLATE --> ARRAYCONFIG
ARRAYCONFIG --> BRANCH
BRANCH --> ARRAY_ELEM
BRANCH --> FLAT_ELEM
```

**Sources:** [source/moss/config/io/configuration.d264-266](../source/moss/config/io/configuration.d#L264-L266) [source/moss/config/io/configuration.d273](../source/moss/config/io/configuration.d#L273-L273) [source/moss/config/io/configuration.d330](../source/moss/config/io/configuration.d#L330-L330)

### Public API Methods and Properties

| Member | Return Type | Description |
| --- | --- | --- |
| `paths` | `const(SearchPath[])` | Returns the search paths used for configuration loading [source/moss/config/io/configuration.d124-127](../source/moss/config/io/configuration.d#L124-L127) |
| `domain` | `const(ConfigurationDomain)` | Returns the configuration domain metadata [source/moss/config/io/configuration.d132-135](../source/moss/config/io/configuration.d#L132-L135) |
| `load(string)` | `void` | Loads configuration from the specified root prefix [source/moss/config/io/configuration.d140](../source/moss/config/io/configuration.d#L140-L140) |
| `snippets` | `auto` | Returns all enabled snippets [source/moss/config/io/configuration.d191-194](../source/moss/config/io/configuration.d#L191-L194) |
| `ids` | `auto` | (Array config only) Returns unique section IDs [source/moss/config/io/configuration.d202-210](../source/moss/config/io/configuration.d#L202-L210) |
| `sections` | `auto` | (Array config only) Returns all merged sections [source/moss/config/io/configuration.d215-218](../source/moss/config/io/configuration.d#L215-L218) |
| `config` | `auto` | (Flat config only) Returns the merged configuration object [source/moss/config/io/configuration.d227-230](../source/moss/config/io/configuration.d#L227-L230) |

**Sources:** [source/moss/config/io/configuration.d124-231](../source/moss/config/io/configuration.d#L124-L231)

## Build Integration

The `moss-config` component is controlled by the `with-config` build option:

```
option('with-config', type: 'boolean', value: true, description: 'Enable moss-config library')
```

This option defaults to `true`, meaning the component is included by default unless explicitly disabled. To disable during build: `meson configure -Dwith-config=false`.

**Sources:** [meson\_options.txt1](../meson_options.txt#L1-L1)

## Usage Pattern

### Typical Usage Flow

**Sources:** [source/moss/config/io/configuration.d92-119](../source/moss/config/io/configuration.d#L92-L119) [source/moss/config/io/configuration.d140-186](../source/moss/config/io/configuration.d#L140-L186)

## Module Structure

The `moss.config.io` package provides a clean public API by re-exporting all major types:

```mermaid
flowchart TD

PKG["moss.config.io<br>package.d"]
CONF_MOD["moss.config.io.configuration"]
SCHEMA_MOD["moss.config.io.schema"]
SNIPPET_MOD["moss.config.io.snippet"]
USER["User Code"]
CONF["Configuration<C>"]
DOMAIN["@ConfigurationDomain"]
YAML_SCHEMA["@YamlSchema"]
YAML_TYPE["YamlType"]
SNIPPET["Snippet<C>"]

PKG --> CONF_MOD
PKG --> SCHEMA_MOD
PKG --> SNIPPET_MOD
USER --> PKG
PKG --> CONF
PKG --> DOMAIN
PKG --> YAML_SCHEMA
PKG --> YAML_TYPE
PKG --> SNIPPET
```

Applications typically only need to import `moss.config.io` to access all configuration functionality [source/moss/config/io/package.d15-19](../source/moss/config/io/package.d#L15-L19)

**Sources:** [source/moss/config/io/package.d1-20](../source/moss/config/io/package.d#L1-L20)

---

For detailed information about configuration class implementation, snippet processing, schema validation rules, and advanced features like configuration masking, see [Configuration Management Deep Dive](4-configuration-management-deep-dive) and its subsections.